name: CI tests

# Reference: https://docs.github.com/en/actions/guides/creating-postgresql-service-containers
# jq, time, and aws are preinstalled in GitHub's ubuntu-20.04 runner

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]
  #schedule:
  #  - cron: '38 2 */3 * *'
  workflow_dispatch:

jobs:
  CI-tests-on-Ubuntu-runner:
    runs-on: ubuntu-20.04
    if: "!contains(github.event.head_commit.message, '[ci skip]') && !contains(github.event.head_commit.message, '[skip ci]')"
    env:
      PGHOST: localhost
      PGPORT: 5432
      PGUSER: postgres
      PGPASSWORD: password
      DB_NAME: opendrr

    services:
      postgis:
        image: postgis/postgis
        env:
          POSTGRES_PASSWORD: password
        ports:
          - 5432:5432
        # Set health checks to wait until postgres has started
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v2

      - name: Run psql to set up opendrr database
        if: ${{ github.event_name != 'schedule' }}
        run: |
          psql --version
          psql -c "CREATE DATABASE ${DB_NAME} OWNER ${PGUSER};"
          psql -d "$DB_NAME" -c 'CREATE SCHEMA boundaries;'
          psql -d "$DB_NAME" -c 'CREATE EXTENSION postgis;'
          psql -d "$DB_NAME" -c 'CREATE EXTENSION postgis_topology;'
          psql -d "$DB_NAME" -c 'CREATE EXTENSION fuzzystrmatch;'
          psql -d "$DB_NAME" -c 'CREATE EXTENSION postgis_tiger_geocoder;'

      - name: Set up python/config.ini
        if: ${{ github.event_name != 'schedule' }}
        env:
          MY_PAT: ${{ secrets.MY_PAT }}
        run: |
          cat <<EOF > python/config.ini
          [auth]
          github_token = $MY_PAT
          EOF
          chmod 600 python/config.ini

      - name: Remove the "wait" at the end of python/add_data.sh
        run: |
          sed '/tail -f \/dev\/null & wait/d' python/add_data.sh

      - name: Dry-run add_data.sh and see if it completes.
        if: ${{ github.event_name != 'schedule' }}
        run: |
          set -x

          sudo rm -rf /usr/src/app
          sudo mkdir /usr/src/app
          sudo chown $(id -un):$(id -gn) /usr/src/app
          cp -a python/* /usr/src/app
          set -a && source sample.env && set +a

          export ADD_DATA_DRY_RUN=true

          cd /usr/src/app
          stdbuf -oL ./add_data.sh

      - name: Run add_data.sh and see how far it goes?
        if: ${{ github.event_name != 'schedule' }}
        run: |
          set -x

          sudo rm -rf /usr/src/app
          sudo mkdir /usr/src/app
          sudo chown $(id -un):$(id -gn) /usr/src/app
          cp -a python/* /usr/src/app
          set -a && source sample.env && set +a

          cd /usr/src/app
          stdbuf -oL ./add_data.sh

  CI-tests-with-Docker-Compose:
    runs-on: ubuntu-20.04
    if: "!contains(github.event.head_commit.message, '[ci skip]') && !contains(github.event.head_commit.message, '[skip ci]')"

    steps:
      - name: Checkout code
        uses: actions/checkout@v2

      - name: Install our own copy of Docker Engine
        run: |
          set -x

          docker version

          # See https://docs.docker.com/engine/install/ubuntu/
          sudo eatmydata apt-get remove docker docker-engine docker.io containerd runc

          sudo apt-get update
          sudo apt-get install \
            apt-transport-https \
            ca-certificates \
            curl \
            gnupg \
            lsb-release

          curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo gpg --dearmor -o /usr/share/keyrings/docker-archive-keyring.gpg

          echo \
            "deb [arch=amd64 signed-by=/usr/share/keyrings/docker-archive-keyring.gpg] https://download.docker.com/linux/ubuntu \
            $(lsb_release -cs) stable" | sudo tee /etc/apt/sources.list.d/docker.list > /dev/null

          sudo apt-get update
          sudo apt-get install docker-ce docker-ce-cli containerd.io

          docker version

      - name: Run "docker compose up --build"
        run: |
          stdbuf -oL docker compose up --build
